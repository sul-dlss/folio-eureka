global: 
  security: 
    allowInsecureImages: true

# production: true

image:
  registry: folioorg
  repository: folio-keycloak
  tag: 26.3.4
  pullPolicy: Always

auth:
  adminUser: admin
  existingSecret: keycloak-credentials
  passwordSecretKey: KC_BOOTSTRAP_ADMIN_PASSWORD

extraEnvVars:
  - name: KEYCLOAK_PROXY_ADDRESS_FORWARDING
    value: "true"
  - name: PROXY_ADDRESS_FORWARDING
    value: "true"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HTTP_PORT
    value: "8080"
  - name: KC_HEALTH_ENABLED
    value: "true"
  - name: KC_LOG_LEVEL
    value: "INFO"
  - name: KC_HOSTNAME_BACKCHANNEL_DYNAMIC
    value: "true"
  - name: KC_HOSTNAME_STRICT
    value: "true"
  # - name: KC_HOSTNAME_STRICT_HTTPS
  #   value: "true"
  # - name: KC_PROXY
  #   value: "edge"
  - name: FIPS
    value: "false"
  - name: KC_HOSTNAME  
    value: "https://keycloak-folio-dev.stanford.edu"
  - name: KC_HOSTNAME_DEBUG
    value: "true"
  - name: KC_FOLIO_BE_ADMIN_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: eureka-common
        key: KC_ADMIN_CLIENT_ID
  - name: KC_FOLIO_BE_ADMIN_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_FOLIO_BE_ADMIN_CLIENT_SECRET
  - name: KC_HTTPS_KEY_STORE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_HTTPS_KEY_STORE_PASSWORD
  - name: KC_DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_DB_PASSWORD
  - name: KC_DB_URL_DATABASE
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_DB_URL_DATABASE
  - name: KC_DB_URL_HOST
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_DB_URL_HOST
  - name: KC_DB_URL_PORT
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_DB_URL_PORT
  - name: KC_DB_USERNAME
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_DB_USERNAME
  - name: KC_BOOTSTRAP_ADMIN_USERNAME
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_BOOTSTRAP_ADMIN_USERNAME
  - name: KC_BOOTSTRAP_ADMIN_PASSWORD
    valueFrom:
      secretKeyRef:
        name: keycloak-credentials
        key: KC_BOOTSTRAP_ADMIN_PASSWORD

proxy: "edge"

resources:
  requests:
    memory: 3072Mi
  limits:
    memory: 4096Mi

postgresql:
  enabled: false

externalDatabase:
  existingSecret: keycloak-credentials
  existingSecretHostKey: KC_DB_URL_HOST 
  existingSecretPortKey: KC_DB_URL_PORT
  existingSecretUserKey: KC_DB_USERNAME
  existingSecretDatabaseKey: KC_DB_URL_DATABASE
  existingSecretPasswordKey: KC_DB_PASSWORD

logging:
  output: default
  level: DEBUG

enableDefaultInitContainers: false

containerSecurityContext:
  enabled: false

networkPolicy:
  enabled: false

service:
  type: "LoadBalancer"
  ports:
    http: 8080
    https: 8443

livenessProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 1
  timeoutSeconds: 10
  failureThreshold: 5
  successThreshold: 1

readinessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 10
  successThreshold: 1

startupProbe:
  enabled: false
  initialDelaySeconds: 30
  periodSeconds: 5
  timeoutSeconds: 1
  failureThreshold: 300
  successThreshold: 1

extraDeploy:
  - |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: eg
      namespace: folio-dev
    spec:
      gatewayClassName: eg
      listeners:
      - hostname: keycloak-folio-dev.stanford.edu
        name: keycloak-folio-dev
        port: 80
        protocol: HTTP
      - hostname: keycloak-admin-folio-dev.stanford.edu
        name: keycloak-admin-folio-dev
  - |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak-backend
      namespace: folio-dev
    spec:
      hostnames:
      - keycloak-folio-dev.stanford.edu
      - keycloak-admin-folio-dev.stanford.edu
      parentRefs:
      - name: eg
      rules:
      - backendRefs:
        - name: keycloak
          port: 8080
        matches:
        - path:
            type: PathPrefix
            value: /
  - |
    apiVersion: gateway.envoyproxy.io/v1alpha1
    kind: SecurityPolicy
    metadata:
      name: ip-limits
    spec:
      targetRefs:
        - group: gateway.networking.k8s.io
          kind: HTTPRoute
          name: keycloak-backend
      authorization:
        defaultAction: Deny
        rules:
          - action: Allow
            principal:
              clientCIDRs:
                - "54.245.203.243, 171.64.0.0/14, 10.32.0.0/15, 10.34.0.0/15, 10.96.0.0/11, 10.98.0.0/15, 10.130.0.0/18, 10.130.64.0/18, 10.130.128.0/18, 10.130.192.0/18, 172.24.0.0/14, 172.20.206.128/25, 172.20.207.0/25, 171.66.16.0/21, 171.66.24.0/21, 171.66.176.0/20, 204.63.231.0/25, 10.109.48.0/25, 10.109.48.128/25, 171.66.1.0/24"
